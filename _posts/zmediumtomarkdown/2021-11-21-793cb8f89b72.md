---
title: Crashlytics + Google Analytics 自動查詢 App Crash-Free Users Rate
author: ZhgChgLi
date: 2021-11-21T14:47:10.076+0000
last_modified_at: 2021-11-21T14:47:10.076+0000
categories: ZRealm Dev.
tags: [crashlytics,ios-app-development,google-analytics,google-apps-script,google-sheets]
description: 使用 Google Apps Script 透過 Google Analytics 查詢 Crashlytics 自動填入到 Google Sheet
image:
  path: assets/793cb8f89b72/1*yPSS8J7o-jowQ6NRYArzjQ.png
render_with_liquid: false
---

### Crashlytics \+ Google Analytics 自動查詢 App Crash\-Free Users Rate

使用 Google Apps Script 透過 Google Analytics 查詢 Crashlytics 自動填入到 Google Sheet


![](/assets/793cb8f89b72/1*yPSS8J7o-jowQ6NRYArzjQ.png)



> _上篇「 [Crashlytics \+ Big Query 打造更即時便利的 Crash 追蹤工具](../e77b80cc6f89/) 」我們將 Crashlytics 閃退紀錄 Export Raw Data 到 Big Query，並使用 Google Apps Script 自動排程查詢 Top 10 Crash & 發布訊息到 Slack Channel。_ 





本篇接續自動化一個與 App 閃退相關的重要數據 — **Crash\-Free Users Rate 不受影響使用者的百分比** ，想必很多 App Team 都會持續追縱、紀錄此數據，以往都是傳統人工手動查詢，本篇目標是將此重複性工作自動化、也能避免人工查詢時可能貼錯數據的狀況；同之前所述，Firebase Crashlytics 沒有提供任何 API 供使用者查詢，所以我們同樣要借助將 Firebase 數據串接到其他 Google 服務，再透過該服務 API 查詢相關數據。


![](/assets/793cb8f89b72/1*nvZXYgkj_8AdqHdR_yTCWg.png)


一開始我以為這個數據同樣能從 Big Query 查詢出來；但其實這方向完全錯誤，因為 Big Query 是 Crash 的 Raw Data，不會有沒有閃退的人的數據，因此也算不出 Crash\-Free Users Rate；關於這個需求在網路上的資料不多，查詢許久才找到有人提到 Google Analytics 這個關鍵字；我知道 Firebase 的 Analytics、Event 都能串到 GA 查詢使用，但沒想到 Crash\-Free Users Rate 這個數據也包含在內，翻閱了 GA 的 API 後，Bingo！


![[API Dimensions & Metrics](https://developers.google.com/analytics/devguides/reporting/data/v1/api-schema?hl=en){:target="_blank"}](/assets/793cb8f89b72/1*4BVf-FMVcY1UbVuLwfKOQg.png)

[API Dimensions & Metrics](https://developers.google.com/analytics/devguides/reporting/data/v1/api-schema?hl=en){:target="_blank"}

[Google Analytics Data API \(GA4\)](https://developers.google.com/analytics/devguides/reporting/data/v1/api-schema#metrics){:target="_blank"} 提供兩個 Metrics：
- **crashAffectedUsers** ：受閃退影響的使用者數量
- **crashFreeUsersRate** ：不受閃退影響的使用者百分比\(小數表示\)


知道路通之後，就可以開始動手實作了！
#### 串接 Firebase \-> Google Analytics

可參考 [官方說明](https://support.google.com/analytics/answer/9289234?hl=zh-Hant){:target="_blank"} 步驟設定，本篇省略。
#### GA4 Query Explorer Tool

開始寫 Code 之前，我們可以先用官方提供的 Web GUI Tool 來快速建造查詢條件、取得查詢結果；實驗完結果是我們想要的之後，再開始寫 Code。前

[前往 >>> GA4 Query Explorer](https://ga-dev-tools.web.app/ga4/query-explorer/){:target="_blank"}


![](/assets/793cb8f89b72/1*qsCMVfWIAzWdZ78LBj8n2A.jpeg)

- 在左上方記得選到 GA4
- 右方登入完帳號後，選擇相應的 GA Account & Property



![](/assets/793cb8f89b72/1*hFJ9KYfecVNmdi4VfDAyIw.png)

- Start Date、EndDate：可直接輸入日期或用特殊變數表示日期 \( `ysterday` , `today` , `30daysAgo` , `7daysAgo` \)



![](/assets/793cb8f89b72/1*GEa3BNpUAqoPD07gE-N21A.png)

- metrics：增加 `crashFreeUsersRate`



![](/assets/793cb8f89b72/1*WygzFvmOLp2kUQC3H_lh2g.png)

- dimensions：增加 `platform` \(設備類型 iOS/Android/Desktop\. \. \. \)



![](/assets/793cb8f89b72/1*RE8SIIVx4PUkqnHQVsJcTg.png)

- dimension filter：增加 `platform` 、 `string` 、 `exact` 、 `iOS` or `Android`


針對雙平台的 Crash Free Users Rate 分別查詢。


![](/assets/793cb8f89b72/1*1NJNUZscuU2XIicgRPGFYg.png)


拉到最下面點擊「Make Request」查看結果，我們就能得到指定日期範圍內的 Crash\-Free Users Rate。


> _可以回頭打開 Firebase Crashlytics 比對同樣條件數據是否相同。_ 
 

> _這邊有發現兩邊數字可能會有微微差距\(我們有一項數字差了 0\.0002\)，原因不明，不過在可以接受的誤差範圍內；若統一都使用 GA Crash\-Free Users Rate 那也不能算是誤差了。_ 




#### 使用 Google Apps Script 自動填入數據到 Google Sheet

再來就是自動化的部分，我們將使用 Google Apps Script 查詢 GA Crash\-Free Users Rate 數據後自動填入到我們的 Google Sheet 表單；已達自動填寫、自動追蹤的目標。


![](/assets/793cb8f89b72/1*kMByIU9_6mxg8-F4BbwLuw.png)


假設我們的 Google Sheet 如上圖。


![](/assets/793cb8f89b72/1*pnJ7gmjDefB9OLl0NgceLA.png)


可以點擊 Google Sheet 上方的 Extensions \-> Apps Script 建立 Google Apps Script 或是 [點此前網 Google Apps Script](https://script.google.com/home/start){:target="_blank"} \-> 左上方 新增專案即可。


![](/assets/793cb8f89b72/1*81_RPPZgBDvW4XplOHGmVg.png)


進來後可以先點上方未命名專案名稱，給個專案名稱。


![](/assets/793cb8f89b72/1*C4qUfJr2UHAzbcksP2zYWA.jpeg)


在左方的「Services」點「\+」加上「Google Analytics Data API」。


![](/assets/793cb8f89b72/1*FfWGQiV2IpOAsQB6TN887g.png)


回到剛剛的 [GA4 Query Explorer](https://ga-dev-tools.web.app/ga4/query-explorer/){:target="_blank"} 工具，在 Make Request 按鈕旁邊可以勾選「Show Request JSON」取得此條件的 Request JSON。

將此 Request JSON 轉換成 Google Apps Script 後如下：
