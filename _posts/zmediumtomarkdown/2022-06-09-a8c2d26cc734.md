---
title: 自行實現 iOS NSAttributedString HTML Render
author: ZhgChgLi
date: 2022-06-09T16:11:59.122+0000
last_modified_at: 2023-03-11T17:16:21.262+0000
categories: ZRealm Dev.
tags: [ios-app-development,nsattributedstring,html-parsing,html,markdown]
description: iOS NSAttributedString DocumentType.html 的替代方案
image:
  path: assets/a8c2d26cc734/1*l93Ay_tGXTRvwS7ofgt5og.jpeg
render_with_liquid: false
---

### 自行實現 iOS NSAttributedString HTML Render

iOS NSAttributedString DocumentType\.html 的替代方案


![Photo by [Florian Olivo](https://unsplash.com/@florianolv?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText){:target="_blank"}](/assets/a8c2d26cc734/1*l93Ay_tGXTRvwS7ofgt5og.jpeg)

Photo by [Florian Olivo](https://unsplash.com/@florianolv?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText){:target="_blank"}
### \[TL;DR\] 2023/03/12

重新使用其他方式開發了 _「 [**ZMarkupParser HTML String 轉換 NSAttributedString 工具**](../a5643de271e4/) 」_ ，技術細節及開發故事請前往「 [手工打造 HTML 解析器的那些事](../2724f02f6e7/) 」
### 起源

從去年 iOS 15 發佈以來，App 始終被一項 Crash 問題長年霸榜，從數據來看，近 90 天 \(2022/03/11~2022/06/08\) 一共造成 2\.4K\+ 次閃退、影響 1\.4K\+ 位使用者。


![](/assets/a8c2d26cc734/1*r--z0J1P6t5ECfVyb5_OxQ.png)



> 此大量閃退問題從數據上看，官方應該已在 iOS ≥ 15\.2 後續的版本修復\(或減少發生機率\)，數據已呈現趨勢下降。 





**最大宗受影響版本：** iOS 15\.0\.X ~ iOS 15\.X\.X

另外有發現 iOS 12、iOS 13 也有零星閃退數，所以此問題應該已存在許久，只是 iOS 15 前幾版發生的機率幾乎是 100%。
#### 閃退原因：


![](/assets/a8c2d26cc734/1*vKmvralAmDrhWrXYLHpspw.png)

```
<compiler-generated> line 2147483647 specialized @nonobjc NSAttributedString.init(data:options:documentAttributes:)
```

NSAttributedString 在 init 時發生 `Crashed: com.apple.main-thread EXC_BREAKPOINT 0x00000001de9d4e44` 閃退問題。


> 亦有可能是操作的地方不在 Main Thread\. 




#### 重現方式：

此問題大量橫空出世時，讓開發團隊想破腦袋；複測 Crash Log 上的點都沒問題，不清楚使用者是在什麼情況下發生的；直到有一次因緣巧合下我剛好切換成「省電模式」然後就觸發問題了\! \! **WTF \! \! \!**


![](/assets/a8c2d26cc734/1*gVfmnCN7QcHO90Y7HyntbA.gif)

### 解答

經過一番搜索發現網路上有許多相同案例，也從 App Developer Forums 找到最早的相同 [閃退問題提問](https://developer.apple.com/forums/thread/115405){:target="_blank"} ，並獲得來自 **官方** 的回答：


![](/assets/a8c2d26cc734/1*XmZuJf4Rtk4chiBx8_yMXw.png)

- 這是已知的 iOS Foundation Bug：自 iOS 12 就已存在
- 如要渲染複雜的、無使用上約束的 HTML：請使用 WKWebView
- **有渲染約束：可自行撰寫 HTML Parser & Render**
- 直接使用 Markdown 做為渲染約束：iOS ≥ 15 NSAttributedString 可 [直接使用 Markdown 格式渲染文字](https://developer.apple.com/documentation/foundation/nsattributedstring/3796598-init){:target="_blank"}



> **渲染約束** 的意思是限定 App 端能支援的渲染格式，例如只支援 **粗體** 、斜體、 [超連結](https://zhgchg.li){:target="_blank"} 。 




#### 補充\. 渲染複雜的 HTML — 想製作文饒圖效果

可與後端共同協調ㄧ個介面：
