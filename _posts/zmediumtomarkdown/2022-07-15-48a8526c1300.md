---
title: iOS 為多語系字串買份保險吧！
author: ZhgChgLi
date: 2022-07-15T10:10:04.867+0000
last_modified_at: 2022-07-15T14:54:56.594+0000
categories: ZRealm Dev.
tags: [ios-app-development,localization,unit-testing,xcode,swift]
description: 確保 Localizable.strings 文字檔不被意外改壞
image:
  path: assets/48a8526c1300/1*G2UsVr02o122GxI2o1WbQQ.jpeg
render_with_liquid: false
---

### iOS 為多語系字串買份保險吧！

使用 SwifGen & UnitTest 確保多語系操作的安全


![Photo by [Mick Haupt](https://unsplash.com/es/@rocinante_11?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText){:target="_blank"}](/assets/48a8526c1300/1*G2UsVr02o122GxI2o1WbQQ.jpeg)

Photo by [Mick Haupt](https://unsplash.com/es/@rocinante_11?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText){:target="_blank"}
### 問題
#### 純文字檔案


![](/assets/48a8526c1300/1*9hxfi00_HcXy0wUMIyU8gA.png)


iOS 的多語系處理方式是 Localizable\.strings 純文字檔案，不像 Android 是透過 XML 格式來管理；所以在日常開發上就會有不小心把語系檔改壞或是漏加的風險再加上多語系不會在 Build Time 檢查出錯誤，往往都是上線後，某個地區的使用者回報才發現問題，會大大降低使用者信心程度。

之前血淋淋的案例，大家 Swift 寫的太習慣忘記 Localizable\.strings 要加 `;` ，導致某個語系上線後從漏掉 `;` 的語句往後全壞掉；最後緊急 Hotfix 才化險為夷。
#### **多語系有問題就會直接把 Key 顯示給使用者**


![](/assets/48a8526c1300/1*BwaK_5ac2gxAmrzt4w-oBA.png)


如上圖所示，假設 `DESCRIPTION` Key 漏加， App就會直接顯示 `DESCRIPTION` 給使用者。
### 檢查需求
- Localizable\.strings 格式正確檢查 \(換行結尾需加上 `;` 、合法 Key Value 對應\)
- 程式碼中有取用的多語系 Key 要在 Localizable\.strings 檔有對應定義
- Localizable\.strings 檔各個語系都要有相應的 Key Value 紀錄
- Localizable\.strings 檔不能有重複的 Key \(否則 Value 會被意外覆蓋\)

### 解決方案
#### 使用 Swift 撰寫完整檢查工具

之前的做法是「 [Xcode 直接使用 Swift 撰寫 Shell Script！](../41c49a75a743/) 」參考 [Localize 🏁](https://github.com/freshOS/Localize){:target="_blank"} 工具使用 Swift 開發 Command Line Tool 從外部做多語系檔案檢查，再把腳本放到 Build Phases Run Script 中，在 Build Time 執行檢查。

**優點：** 
檢查程式是由外部注入，不依賴在專案上，可以不透過 XCode、不需 Build 專案也能執行檢查、檢查功能能精確到哪個檔案的第幾行；另外還能做 Format 功能 \(排序多語系 Key A\->Z\)。

**缺點：** 
增加 Build Time \( \+ ~= 3 mins\)、流程發散，腳本有問題或需因應專案架構調整時難以交接維護，因這塊不在專案內，除了加入這段檢查進來的人知道整個邏輯，其他協作者很難碰觸到這塊。


> 有興趣的朋友可以參考之前的那篇文章，本篇主要介紹的方式是透過 XCode 13\+SwiftGen\+UnitTest 來達成檢查 Localizable\.strings 的所有功能。 




#### XCode 13 內建 Build Time 檢查 Localizable\.strings 檔案格式正確性


![](/assets/48a8526c1300/1*p28LgNGZYh6S8T2s2UH8lg.png)


升級 XCode 13 之後就內建了 Build Time 檢查 Localizable\.strings 檔案格式的功能，經測試檢查的規格相當完整，除了漏掉 `;` 外如有多餘無意義的字串也會被擋下來。
#### 使用 SwiftGen 取代原始 NSLocalizedString String Base 存取方式

[SwiftGen](https://github.com/SwiftGen/SwiftGen){:target="_blank"} 能幫助我們將原本的 NSLocalizedString String 存取方式改成 Object 存取，防止不小心打錯字、忘記在 Key 宣告的情況出現。


[![](https://repository-images.githubusercontent.com/39166950/1826ed00-d6cf-11ea-9736-34829910d1e6)](https://github.com/SwiftGen/SwiftGen){:target="_blank"}


SwiftGen 核心也是 Command Line Tool；但是這工具在業界蠻流行的而且有完整的文件及社群資源在維護，不必害怕導入這個工具後續難維護的問題。

[**Installation**](https://github.com/SwiftGen/SwiftGen#installation){:target="_blank"}

可依照您的環境或 CI/CD 服務設定去選擇安裝方式，這邊 Demo 直接用最直接的 CocoaPods 進行安裝。


> 請注意 SwiftGen 並不是真的 CocoaPods，他不會跟專案中的程式碼有任何依賴；使用 CocoaPods 安裝 SwiftGen 單純只是透過它下載這個 Command Line Tool 執行檔回來。 





在 `podfile` 中加入 swiftgen pod：
```
pod 'SwiftGen', '~> 6.0'
```

**Init**

`pod install` 之後打開 Terminal `cd` 到專案下
```
/L10NTests/Pods/SwiftGen/bin/swiftGen config init
```

init `swiftgen.yml` 設定檔，並打開它
