---
title: 打造舒適的 WFH 智慧居家環境，控制家電盡在指尖
author: ZhgChgLi
date: 2020-04-20T14:37:49.536+0000
last_modified_at: 2021-02-24T01:39:50.697+0000
categories: ZRealm Life.
tags: [homekit,iphone,homebridge,米家,生活]
description: 示範使用樹莓派當 HomeBridge 主機，將所有米家家電串上 HomeKit
image:
  path: assets/99db2a1fbfe5/1*qZeTn0r2u_MKJXubV17XvQ.jpeg
render_with_liquid: false
---

### 打造舒適的 WFH 智慧居家環境，控制家電盡在指尖

示範使用樹莓派當 HomeBridge 主機，將所有米家家電串上 HomeKit


![photo by [picjumbo\.com](https://www.pexels.com/zh-tw/@picjumbo-com-55570?utm_content=attributionCopyText&utm_medium=referral&utm_source=pexels){:target="_blank"}](/assets/99db2a1fbfe5/1*qZeTn0r2u_MKJXubV17XvQ.jpeg)

photo by [picjumbo\.com](https://www.pexels.com/zh-tw/@picjumbo-com-55570?utm_content=attributionCopyText&utm_medium=referral&utm_source=pexels){:target="_blank"}
### 關於

因為疫情的關係，在家時間變長了；尤其是要 Work From Home 的話，家裡的電器設備最好都能在 APP 上智能控制，就不用一下子離開去開燈、一下子去開電鍋…等等，很浪費時間。

之前寫過一篇「 [**智慧家居初體驗 — Apple HomeKit & 小米米家**](../c3150cdc85dd/) **」** ，初試使用 HomeBridge 將小米家電串上 HomeKit，實證理論上可行，但實際應用提到的不多，今天這篇算是綜合前篇的進階完整版，包含選擇樹莓派當主機的話該怎麼設定，從頭到尾手把手教學。

起因是最近換了 iPhone 11 Pro 能支援 iOS ≥ 13 捷徑的 NFC 自動化功能，就是手機感應到 NFC Tag 就能執行相應的捷徑；雖然 **可以直接拿舊的悠遊卡當 NFC Tag** ，但太占空間也沒那麼多張卡；我去光華問了一圈都沒有再賣 NFC Tag 感應貼紙，最後才在蝦皮找到 $50 一張，買了 5 張來玩玩，賣家還很貼心的幫我用顏色區隔開。


![](/assets/99db2a1fbfe5/1*6ftbgAxlvmdv-35of98ohA.jpeg)


_\*NFC 自動化功能是綁機型的，只有 iPhone XS/XS max/XR/11/11pro/11pro max 支援這個功能，之前拿 iPhone 8 完全沒 NFC這選項。_

稍微把玩了一下發現有個問題，就是執行米家 APP 的捷徑時一定要打開「執行時顯示」選項（否則不會真的執行）， **感應到 Tag 要執行時還要解鎖 iPhone 、執行時也會開啟捷徑，無法在後台直接感應執行** ；另外實測了如果捷徑是原生蘋果的服務（如：HomeKit 的家電）就能在背景&免解鎖下直接執行；而且 homeKit 的反應速度、穩定度都比米家好很多。

這在爽度上有很大的差別，所以就又深入研究了將米家智慧家居系列的產品都接上 HomeKit，有支援 HomeKit 的就直接綁定本篇不贅述；不支援的就照此文教學也一起綁定上去！
### 我的米家智慧家居項目
1. 米家智慧攝影機 雲台版 1080P
2. 米家直流變頻電風扇
3. 米家 LED 智慧檯燈
4. 小米空氣淨化器 3
5. 米家檯燈 Pro（本身就支援 HomeKit）
6. 米家 LED 智慧燈泡 彩光版 \* 2 （本身就支援 HomeKit）

### 運作原理


![](/assets/99db2a1fbfe5/1*7p0ehajJqdqb4-_w9uHt7g.jpeg)


做了一張簡易的參考圖，如果智慧家電有支援 HomeKit 就直接串上去、 **不支援的智慧家電透過架設「HomeBridge」服務主機（要一直開機）也能橋接串上去** ；在同一個網路環境下（EX: 同個 WiFi）iPhone 可以自由地控制 HomeKit 中的所有家電項目；但若在外部網路，如 **4G 行動網路情況下，就需要有一台 Apple TV/HomePod 或 iPad 當家庭中樞主機，在家待命（一樣要一直開著）** 才能在外面控制家中的 HomeKit，若無家庭中樞在外面打開家庭 APP 會顯示「 **無回應** 」。


> \*若是米家的話，會經由米家伺服器控制家裡的電器，要說的話 **會有安全問題，資料都要經過大陸** 。 




### 需求環境

所以一共有兩個設備要一直開著待命，一台是 Apple TV/HomePod 或 iPad 家庭中樞主機；這部分目前無解，無法用其他方式模擬，只能想辦法取得這些設備，如果沒有就只能在家使用 HomeKit **。**

另一台只要是能 24 hr 待命的電腦（如您的 iMac/MacBook）、閒置的主機（舊的 iMac、Mac Mini）或樹莓派都可以。


> \*windows 系列未嘗試，不過應該也可以！ 





亦或是你想玩玩也可以直接用目前的電腦來用（可搭配 [前篇文章](../c3150cdc85dd/) 一起服用）。

本文將以樹莓派（Raspberry Pi 3B）、使用 Macbook Pro \(MacOS 10\.15\.4\) 操作下作示範，從設定樹莓派的環境從頭開始講；若不是使用樹莓派的朋友可以直接略過跳到 HomeBridge 串接 HomeKit 的部分（這裡都一樣）。


![Raspberry Pi 3B \(special thanks to [Lu Xun Huang](https://medium.com/u/b32ce1b681f8){:target="_blank"} \)](/assets/99db2a1fbfe5/1*go-wGMdV1VVbJ3c00rh0_w.jpeg)

Raspberry Pi 3B \(special thanks to [Lu Xun Huang](https://medium.com/u/b32ce1b681f8){:target="_blank"} \)

**若是使用樹莓派還需要一張 micro SD 記憶卡（不用太大，我用 8G）、讀卡機、網路線（設定用，之後可連 WiFi）；還有樹莓派需要的軟體：**
1. [樹莓派桌面版作業系統（方便大家入門，使用 GUI 版）](https://downloads.raspberrypi.org/raspbian_latest){:target="_blank"}
2. [Etcher 燒錄軟體](https://www.balena.io/etcher/){:target="_blank"}

### 樹莓派環境設定
#### 燒錄作業系統

下載完需求的兩個軟體後，我們先將記憶卡放入讀卡機插上電腦；打開 Etcher 程式（balenaEtcher）


![第一項選擇剛下載的樹莓派作業系統「xxxx\.img」、第二項選擇你的記憶卡裝置，然後點擊「Flash\!」開始燒錄！](/assets/99db2a1fbfe5/1*3YcqdSf9z5RNqD6KJkd4Nw.png)

第一項選擇剛下載的樹莓派作業系統「xxxx\.img」、第二項選擇你的記憶卡裝置，然後點擊「Flash\!」開始燒錄！


![此時會跳出要你輸入 **MacOS 的密碼** ，輸入後按「Ok」繼續。](/assets/99db2a1fbfe5/1*o9XE1WYrBpeKSE31Ob9gcQ.png)

此時會跳出要你輸入 **MacOS 的密碼** ，輸入後按「Ok」繼續。


![燒錄中…請稍候…\.](/assets/99db2a1fbfe5/1*Z9oOKg9KPMpj3TZfvOvYeA.png)

燒錄中…請稍候…\.


![驗證中…請稍候…\.](/assets/99db2a1fbfe5/1*2G930lN4q4MVs4LCeE5y1w.png)

驗證中…請稍候…\.


![燒錄成功！](/assets/99db2a1fbfe5/1*CEB4bAMTQshY3u7MEC3q5w.png)

燒錄成功！


> \*若有出現紅色的 Error ，可嘗試將記憶卡格式化後再次燒錄。 





重新將讀卡機接上電腦，並在記憶卡內容目錄下建立一個空的 「ssh」 檔案（ [或點此下載](https://drive.google.com/file/d/1vSiMkRB1-5tO1hD4YnXxUcULTnCJBIFX/view?usp=sharing){:target="_blank"} ）內容空白、不用副檔名，就是個「ssh」檔；讓我們可以用 **Terminal** 連線進樹莓派。


![ssh](/assets/99db2a1fbfe5/1*aGJHebPl5MMf4iy0Um9bjg.png)

ssh
### 設定樹莓派

將記憶卡退出，插入樹莓派上並接上網路線，然後通電開機；並讓 MacBook 跟樹莓派在同個網路環境下。
#### **查看樹莓派分配到的 IP 位置**


![](/assets/99db2a1fbfe5/1*6HZ0Fqp6cgpn1F3_4UwM0Q.png)


得到 樹莓派分配到的 IP 位置是： **192\.168\.0\.110 \(本文所有出現的 IP 請自行更換成你查到的結果\)**


> **_建議將樹莓派設定為指定/保留 IP，否則開機重連後 IP 位置可能會變動，要重新查。_** 




#### 使用 SSH 連入樹莓派進行操作

打開 Terminal 輸入：

`ssh pi@你的樹莓派IP位址`

有詢問就輸入 `yes` ，密碼輸入預設密碼： `raspberry`


![**連線成功！**](/assets/99db2a1fbfe5/1*okEJeW9xZN8XFfRYJyp4Xg.png)

**連線成功！**


> \*若有出現 WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED 之類的錯誤訊息就先去 /Users/xxxx/\.ssh/known\_hosts 用文字編輯器打開清空即可 




#### 樹莓派基本工具安裝、設定

**1\.輸入以下指令安裝 Vim 編輯器：**

`sudo apt-get install vim`


![](/assets/99db2a1fbfe5/1*QfhJwWvicEGfk_8PFLy7pA.png)


**2\.解決以下語系警告：**
```
perl: warning: Setting locale failed.
perl: warning: Please check that your locale settings:
    LANGUAGE = (unset),
    LC_ALL = (unset),
    LC_LANG = "zh_TW.UTF-8",
    LANG = "zh_TW.UTF-8"
    are supported and installed on your system.
perl: warning: Falling back to the standard locale ("C").
```

**輸入**

`vi .bashrc`

按「Enter」進入

按「 `i` 」進入編輯模式

移動到文件最底部，加上一行「 `export LC_ALL=C` 」

按「Esc」輸入「 `:wq!` 」儲存退出。

再下「 `source .bashrc` 」更新即可。


![](/assets/99db2a1fbfe5/1*Z3E5QTXErDmmNVRd5QYo8g.gif)


**3\.安裝 nvm 管理 nodejs/npm：**
```
curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.33.11/install.sh | bash
```

**4\.用 nvm 安裝最新版 [nodejs](https://nodejs.org/en/){:target="_blank"} ：**

`nvm install 12.16.2`


> \*這邊選擇安裝「12\.16\.2」版本 





**5\.確認環境安裝完成：**

**輸入以下指令**

`npm -v`

**和**

`node -v`

**確認**


![沒錯誤訊息即可！](/assets/99db2a1fbfe5/1*u3xgdplBB-7DyvSpAJU4dA.png)

沒錯誤訊息即可！

**6\.建立 nodejs 連結**

**輸入以下指令**

`which node`

取得 nodejs 所在路徑資訊

**再輸入**

`sudo ln -fs 這邊貼上你 which node 查到的路徑(不用”雙引號) /usr/local/bin/node`

**建立連結**


![](/assets/99db2a1fbfe5/1*L5C-2SCUV-Cf4yCDwYy8eg.png)


**設定完成！**
#### **啟用樹莓派 VNC 遠端桌面功能**

這邊我們雖然是裝 GUI 版，你當然可以直接將樹莓派接上鍵盤、HDMI 當一般電腦使用，但為了方便我們將使用遠端桌面的方式控制樹莓派。

**輸入：**

`sudo raspi-config`


![](/assets/99db2a1fbfe5/1*_Hwvt6tkKhsNE9TDkOaYAA.png)


**進入設定：**


![選擇第五項「 **Interfacing Options** 」](/assets/99db2a1fbfe5/1*_EMj-6phsY5PjrPjqeavDg.png)

選擇第五項「 **Interfacing Options** 」


![選擇第三項「 **P3 VNC** 」](/assets/99db2a1fbfe5/1*CAHN3qczUpajbGGU9gaD9g.png)

選擇第三項「 **P3 VNC** 」


![使用 「 **←** 」選擇「 **Yes** 」打開](/assets/99db2a1fbfe5/1*wq4S5b33MpAJUiqt9z1EMg.png)

使用 「 **←** 」選擇「 **Yes** 」打開


![**VNC 遠端桌面功能啟用成功！**](/assets/99db2a1fbfe5/1*sTZ8x9M-_5FRwdqy4mKvPw.png)

**VNC 遠端桌面功能啟用成功！**


![使用 「 **→** 」直接切到「 **Finish** 」退出設定介面。](/assets/99db2a1fbfe5/1*81Y7wZjbSS8Tf5Z_OHi3Rw.png)

使用 「 **→** 」直接切到「 **Finish** 」退出設定介面。
#### **將 VNC 遠端桌面服務加入到開機自動啟動項**

我們希望 VNC 遠端桌面服務是樹莓派開機後就自動啟用的。

**輸入**

`sudo vim /etc/init.d/vncserver`

按「Enter」進入

按「 `i` 」進入編輯模式
