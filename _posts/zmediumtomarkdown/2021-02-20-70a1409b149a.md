---
title: 使用 Python+Google Cloud Platform+Line Bot 自動執行例行瑣事
author: ZhgChgLi
date: 2021-02-20T11:55:51.105+0000
last_modified_at: 2021-11-21T14:52:42.902+0000
categories: ZRealm Dev.
tags: [google-cloud-platform,cloud-functions,cloud-scheduler,ios-app-development,python]
description: 以簽到 APP 獎勵為例，打造每日自動簽到腳本
image:
  path: assets/70a1409b149a/1*dFvxm6SynzYOmMEUALKJaA.jpeg
render_with_liquid: false
---

### 使用 Python\+Google Cloud Platform\+Line Bot 自動執行例行瑣事

以簽到獎勵 APP 為例，打造每日自動簽到腳本


![Photo by [Paweł Czerwiński](https://unsplash.com/@pawel_czerwinski?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText){:target="_blank"}](/assets/70a1409b149a/1*dFvxm6SynzYOmMEUALKJaA.jpeg)

Photo by [Paweł Czerwiński](https://unsplash.com/@pawel_czerwinski?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText){:target="_blank"}
### 起源

一直以來都有使用 Python 做小工具的習慣；有做正經的，工作上自動爬數據、產報表，也有不正經的，排程自動查想要的資訊或是交給腳本完成本來要手動執行的動作。

一直以來「自動」這件事，我都很粗暴直接開一台電腦掛著 Python 腳本讓他掛著跑；優點是簡單方便，缺點是要有台設備接著網路接著電；就算是樹莓派也是要消耗著微量的電費網路錢，還有也不能遠端控制啟動或關閉（其實可以，但很麻煩）；這次趁著工作空擋，研究了一下免費&上雲端的方法。
### 目標


> 將 Python 腳本搬到雲端執行、定時自動執行、可透過網路開啟/關閉。 





> _本篇以我耍的小聰明，針對簽到獎勵型 APP 撰寫的自動完成簽到的腳本為例，能每日自動幫我簽到，我不用在特別打開 APP 使用；並在執行完成後發通知給我。_ 






![完成通知！](/assets/70a1409b149a/1*14yKaOt2YNSMILOD_EoXLg.png)

完成通知！
#### 本篇章節順序
1. 使用 Proxyman 進行 Man in the middle attack API 嗅探
2. 撰寫 Python 腳本，偽造 APP API 請求（模擬簽到動作）
3. 將 Python 腳本搬到 Google Cloud 上
4. 在 Google Cloud 設定自動排程

- 因涉及到敏感領域本篇不會告知是哪個簽到獎勵型 APP，大家可以延伸自行使用
- **如果只想了解 Python 怎麼串自動執行可跳過前半段 Man in the middle attack API 嗅探部分，從第 3 章看起** 。

#### 使用到的工具
- **Proxyman** ：Man in the middle attack API 嗅探
- **Python** ：撰寫腳本
- **Linebot** ：發送腳本執行結果通知給自己
- **Google Cloud Function** ：Python 腳本寄存服務
- **Google Cloud Scheduler** ：自動排程服務

### 1\.使用 Proxyman 進行 Man in the middle attack API 嗅探

之前有發過一篇「 [APP有用HTTPS傳輸，但資料還是被偷了。](../46410aaada00/) 」的文章，道理類似，不過這次改用 Proxyman 取代 mitmproxy；同樣免費，但更好用。
- 到官網 [https://proxyman\.io/](https://proxyman.io/){:target="_blank"} 下載 Proxyman 工具
- 下載完後啟動 Proxyman，安裝 Root 憑證（為了做 Man in the middle attack 解包 https 流量內容）



![](/assets/70a1409b149a/1*jb-FAN5h1oFVFFvu1bpYgw.png)


「Certificate 」\->「 Install Certificate On this Mac」\->「Installed & Trusted」

**電腦的 Root 憑證裝好後換手機的：**

「Certificate 」\->「 Install Certificate On iOS」\->「Physical Devices…」


![](/assets/70a1409b149a/1*DBi9YVmfoaPH9WSCoPXycA.png)


依照指示在手機上掛好 Proxy 並完成憑證安裝及啟用。
- 在手機上打開想要嗅探 API 傳輸內容的 APP



![](/assets/70a1409b149a/1*q2wbmQ3MJ6nYfjFSBHL9fw.png)


這時候 Mac 上的 Proxyman 就會出現嗅探到的流量，點擊裝置 IP 下想要查看的 APP API 網域；第一次查看需要先點「Enable only this domain」之後的流量才能被解包出來。

**「Enable only this domain」後就能看到新攔截的流量就會出現原始的 Request、Response 資訊：**


![](/assets/70a1409b149a/1*dIp1k-0u-BhJ7iTs0wEIuA.png)



> _我們使用此方法嗅探 APP 上操作簽到時打了哪隻 API EndPoint 及帶了哪些資料，將這些資訊記錄下來，等下使用 Python 直接模擬請求。_ 





> _⚠️要注意有的 APP token 資訊可能會換，導致日後 Python 模擬請求失效，還要多了解 APP token 交換的方式。_ 





> _⚠️如果確定 Proxyman 有正常運作，但在掛 Proxyman 的情況下 APP 無法發出請求，代表 APP 可能有做 SSL Pining；目前無解，只能放棄。_ 





> _⚠️APP 開發者想知道怎麼防範嗅探可參考 [之前的文章](../46410aaada00/) 。_ 




#### **這邊假設我們得到的資訊如下：**
```
POST /usercenter HTTP/1.1
Host: zhgchg.li
Content-Type: application/x-www-form-urlencoded
Cookie: PHPSESSID=dafd27784f94904dd586d4ca19d8ae62
Connection: keep-alive
Accept: */*
User-Agent: (iPhone12,3;iOS 14.5)
Content-Length: 1076
Accept-Language: zh-tw
Accept-Encoding: gzip, deflate, br
AuthToken: 12345
```
### 2\. 撰寫 Python 腳本，偽造 APP API 請求（模擬簽到動作）


> _在撰寫 Python 腳本之前，我們可先使用 [Postman](https://www.postman.com/){:target="_blank"} 調試一下參數，觀察看看哪個參數是必要的或是有時效會改變；但要直接照搬也可以。_ 






![](/assets/70a1409b149a/1*eVF56j1oOgXeZYbkD1m22g.png)

